#!/usr/bin/env python3
"""
Script ƒë·ªÉ t·∫°o l·∫°i b·∫£ng loaichiphi v·ªõi c·∫•u tr√∫c m·ªõi
"""
import sys
import os
sys.path.append(os.path.dirname(__file__))

from supabase_client import supabase

def recreate_loaichiphi_with_new_schema():
    """T·∫°o l·∫°i b·∫£ng loaichiphi v·ªõi schema m·ªõi"""
    try:
        print("üöÄ B·∫Øt ƒë·∫ßu t·∫°o l·∫°i b·∫£ng loaichiphi v·ªõi c·∫•u tr√∫c m·ªõi...")

        # Drop b·∫£ng c≈© n·∫øu t·ªìn t·∫°i
        try:
            drop_sql = "DROP TABLE IF EXISTS loaichiphi CASCADE"
            supabase.rpc('exec_sql', {'sql': drop_sql})
            print("‚úÖ ƒê√£ x√≥a b·∫£ng c≈©")
        except Exception as e:
            print(f"‚ö†Ô∏è  Kh√¥ng th·ªÉ x√≥a b·∫£ng c≈©: {str(e)}")

        # T·∫°o b·∫£ng m·ªõi v·ªõi c·∫•u tr√∫c m·ªõi
        create_sql = '''
        CREATE TABLE public.loaichiphi (
          id bigint generated by default as identity not null,
          loaichiphi character varying null,
          tenchiphi character varying null,
          giathanh numeric null,
          constraint loaichiphi_pkey primary key (id)
        ) TABLESPACE pg_default;
        '''
        supabase.rpc('exec_sql', {'sql': create_sql})
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng m·ªõi v·ªõi c·∫•u tr√∫c m·ªõi")

        # Insert d·ªØ li·ªáu m·∫´u
        sample_data = [
            {
                'loaichiphi': 'bi·∫øn ph√≠',
                'tenchiphi': 'Chi ph√≠ nguy√™n v·∫≠t li·ªáu',
                'giathanh': None
            },
            {
                'loaichiphi': 'ƒë·ªãnh ph√≠',
                'tenchiphi': 'Chi ph√≠ nh√¢n c√¥ng',
                'giathanh': 5000000
            },
            {
                'loaichiphi': 'bi·∫øn ph√≠',
                'tenchiphi': 'Chi ph√≠ v·∫≠n chuy·ªÉn',
                'giathanh': None
            },
            {
                'loaichiphi': 'bi·∫øn ph√≠',
                'tenchiphi': 'Chi ph√≠ marketing',
                'giathanh': None
            },
            {
                'loaichiphi': 'ƒë·ªãnh ph√≠',
                'tenchiphi': 'Chi ph√≠ vƒÉn ph√≤ng',
                'giathanh': 2000000
            },
            {
                'loaichiphi': 'bi·∫øn ph√≠',
                'tenchiphi': 'Chi ph√≠ b·∫£o tr√¨',
                'giathanh': None
            },
            {
                'loaichiphi': 'ƒë·ªãnh ph√≠',
                'tenchiphi': 'Chi ph√≠ ƒëi·ªán n∆∞·ªõc',
                'giathanh': 1500000
            },
            {
                'loaichiphi': 'ƒë·ªãnh ph√≠',
                'tenchiphi': 'Chi ph√≠ thu√™ m·∫∑t b·∫±ng',
                'giathanh': 10000000
            }
        ]

        # Insert t·ª´ng record
        for item in sample_data:
            try:
                result = supabase.table('loaichiphi').insert(item).execute()
                print(f"‚úì ƒê√£ t·∫°o: {item['tenchiphi']} ({item['loaichiphi']})")
            except Exception as e:
                print(f"‚ùå L·ªói khi t·∫°o {item['loaichiphi']}: {str(e)}")

        print(f"\n‚úÖ Ho√†n th√†nh! ƒê√£ t·∫°o {len(sample_data)} lo·∫°i chi ph√≠ m·∫´u v·ªõi c·∫•u tr√∫c m·ªõi.")

    except Exception as e:
        print(f"‚ùå L·ªói: {str(e)}")

if __name__ == "__main__":
    recreate_loaichiphi_with_new_schema()
